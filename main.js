let sendingQuery=!1;var promptCurrentText=!1,promptTime=0,xpathFirstChatMessage="/html/body/div/div/div[1]/main/div[1]/div/div/div/div[1]/div/div[2]/div[1]/div",xpathChatgptHomeMessage="/html/body/div/div[1]/div[1]/main/div[1]/div/div/div/div[1]/h1";const allAnswers=()=>[...document.querySelectorAll(".markdown.prose")];var getPreLastMessage=()=>(messages=document.querySelectorAll(".text-base .markdown"))[messages.length-2];function lookAndInputPrompt(){try{chrome.storage.local.get(["promptCurrentText"],t=>{t.promptCurrentText&&chrome.storage.local.get(["promptTime"],t=>{t.promptTime+6e5>Date.now()&&chrome.storage.local.get(["promptLastText"],t=>{sendPrompt(t.promptLastText)})})})}catch(t){console.log("no active query found")}}waitForElement("body > div:nth-child(4) > span > div > div > div",t=>{t.style.display="none",toast(t.textContent,{time:4e3})},5e3,5),setInterval(()=>{var t=document.querySelector("body > div > div > div > div > h2");t&&t.textContent.includes("a client-side exception has occurred")&&(t.innerHTML="Hey, an unknown error has occurred. Drop a mail to ai@productivity.rocks to let the developers know!\nIf you know how to attach the console log, that would be helpful.")},500),window.addEventListener("load",()=>{handleStorage("get","updateNotify","",t=>{let c="1.9.3";t&&t===c||waitForElement("nav a, form textarea",async()=>{const t=Object.assign(document.createElement("div"),{id:"featureNotifier"});var e=Object.assign(document.createElement("div"),{className:"topBar"}),e=(t.appendChild(e),e.appendChild(Object.assign(document.createElement("span"),{style:`
                        font-size: 14px;
                        color: #a4a4a4;
                    `,innerText:"v "+c})),e.appendChild(Object.assign(document.createElement("h2"),{textContent:"ChatGPT Optimizer",style:`
                        transform: translate(-14px);
                        font-size: 14px;
                        line-height: 24px;
                        color: #a4a4a4;
                        top: 1.25rem;
                    `})),e.appendChild(Object.assign(document.createElement("div"),{className:"close",onclick:()=>{t.close()}})),featuresContent=Object.assign(document.createElement("div"),{className:"content"}),`
                <h4>Release Note</h4>
                <a href="${urlIdeaSubmission}" target="_blank" style="background: #ddd;padding: 0.4rem 1rem;color: rgb(32, 32, 34);font-weight: 600;border-radius: 0.6rem;cursor: pointer;font-size: .7rem;">Submit Your Idea üì´</a>
                `);let o=`
                <li style="list-style:'üåê';">
                <p>Quick Prompt To Fetch URL</p>
                <img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/quick-prompt-urls.png"/>
            </li>
            <li style="list-style:'üó£Ô∏è';">
                <p>Add Persistence Voice Settings</p>
                <img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/persitance-voice-setting.png"/>
            </li>
            <li style="list-style:'üëÄ';">
                <p>Glass Morph Theme</p>
                <img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/glass-morph-theme.png"/>
            </li>
<li style="list-style:'üì•';"><p>Added CSV Export</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/csv-export.png"/></li><li style="list-style:'2Ô∏è‚É£';"><p>Chat Split View</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/split-view.png"/></li><li style="list-style:'üì§';"><p>Upload CSS, HTML and Text documents</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/upload-css-html-txt.png"/></li><li style="list-style:'üëå';"><p>Make Message Width Adjustable</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/ajustable-message-width.png"/></li><li style="list-style:'üñäÔ∏è';"><p>Combined Rewrite Buttons</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/combine-quick-prompts.png"/></li><li style="list-style:'üíª';"><p>Blur Nav Elements for Presentation</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/blur-chats.png"/></li><li style="list-style:'üóíÔ∏è';"><p>Expand/collapse button for prompt field</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/collabse-expand-prompt-field.png"/></li><li style="list-style:'üí®';"><p>Unite one Export Button</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/unite-export-button.png"/></li><li style="list-style:'‚öôÔ∏è';"><p>Improved Settings Popup</p><img src="https://productivity.rocks/tool/ai-optimizer/api/featureNotify/imgs/improved-settings-popup.png"/></li><li style="list-style:'üì∫';"><p>Improved Screenshot Export</p></li><li style="list-style:'üöÆ';"><p>Improved Quick Delete</p></li><li><p>Fix Prompt History & Chart (Higher Length)</p></li><li style="list-style:'üëì';"><p>Fix selection readability in light theme</p></li><li style="list-style:'‚úÖ';"><p>Fix Selection and page Prompting</p></li><li style="list-style:'üóíÔ∏è'; margin-top: .8rem;"><p><b>Note:</b><br>Hey, I'm working hard to make this a great extension I would be very happy if you like this <a href="https://productivity.rocks/tool/ai-optimizer/" target="_blank">leaving a 5 star rating ‚ú®</a> and if you don't <a href="${urlIdeaSubmission}" target="_blank">submit feedback ü§î</a>. All your requests will be answered within 24h. Currently ChatGPT has some issues with their platform, please know that I can't change that: But within the upcoming weeks I'll launch a own chat platform which you can access at any time without any issues.</p>
            </li>`;try{var i=await fetch("https://productivity.rocks/tool/ai-optimizer/api/featureNotify/v1.9.3/");if(!i.ok)throw new Error("Network response was not ok.");o=await i.text()}catch(t){console.error("There was a problem fetching the URL:",t)}featuresContent.innerHTML=`
                <div class="header">
                    ${e}
                </div>
                <div class="question">
                    <h4>‚ú® Vote For Feature üó≥Ô∏è</h4>
                    
                    <div>
                        <h4>Should This Extension Add Prompting Features Trough All The Web?</h4>
                        <p>Would you like this extension to make it possible to prompt ChatGPT from any webpage, so that you can, for example, ask questions related to the page content? And also add automated GPT Answers windows to popular websites such as Wikipedia and Google? These features will be available in both the free and pro plans and can be toggled via settings. </p>
                        <div class="decide">
                            <button class="gpto-button yes">Yes</button>
                            <button class="gpto-button no">No</button>
                        </div>
                    </div>
                
                </div>
                <ol style='list-style: circle; font-size: .8rem; padding-left: 1rem;'>
                    ${o}
                </ol>
                `,t.appendChild(featuresContent);const n=featuresContent.querySelector(".question");function r(t){var e=new XMLHttpRequest,t=(e.open("POST","https://productivity.rocks/tool/ai-optimizer/api/votings/promptEverywhere/"),e.setRequestHeader("Content-Type","application/json"),{vote:t});e.send(JSON.stringify(t))}n.querySelector(".yes").addEventListener("click",()=>{console.log("voted for yes"),r("yes"),n.remove()}),n.querySelector(".no").addEventListener("click",()=>{console.log("voted for no"),r("no"),n.remove()});const a=Object.assign(document.createElement("div"),{style:`
                        min-height: .4rem;
                        width: 100%;
                        border-radius: 10rem;
                        background: #d2d2d2;
                        bottom: 0px;
                        transition: all 6s linear 0s;
                        position: sticky;
                        align-self: flex-start;
                        opacity: .4;
                        margin: .6rem auto auto auto;
                    `});t.appendChild(a);let s,l;t.startCountdown=()=>{s=setTimeout(()=>{a.style.transition="6s linear",a.style.width="0%",l=setTimeout(()=>{t.close()},6e3)},100)},t.close=()=>{t.remove(),handleStorage("set","updateNotify",c)},t.startCountdown(),t.addEventListener("mouseenter",()=>{s&&clearTimeout(s),l&&clearTimeout(l);var t=a.style.transition;setTimeout(()=>{a.style.transition=".15s ease-in-out",a.style.width="100%",setTimeout(()=>{a.style.transition=t},100)},1)}),t.addEventListener("mouseleave",()=>{t.startCountdown()}),document.body.appendChild(t)})}),waitForElement("nav a, form textarea",()=>{},5e3,100,()=>{toast("chat not loading, try reloading the page")}),waitForElement("main > :nth-child(2) form > :nth-child(1) > :nth-child(2)",t=>{t.click()}),"https://chat.openai.com/auth/login"==window.location.href&&waitForElement(".text-3xl.font-medium",t=>{t.innerText.contains("capacity right now")&&(window.location.href="https://chat.openai.com")}),waitForElement("main > div.overflow-hidden",t=>{t=t.firstChild;t.scrollTop=t.scrollHeight}),handleStorage("get","theme","",t=>{setTheme(t)}),document.addEventListener("keydown",t=>{var e;t.ctrlKey&&"c"===t.key||t.metaKey&&"c"===t.key?""===window.getSelection().toString().trim()?(isFinite(t.clientX)&&isFinite(t.clientY)&&(e=document.elementFromPoint(t.clientX,t.clientY)).matches("button.gpt-optimizer")?e:getLastMessage().parentNode.querySelector("button.gpt-optimizer")).click():(navigator.clipboard.writeText(window.getSelection().toString()),toast("Copied Selection")):"Space"===t.code||" "===t.key?"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&(t.preventDefault(),document.body.classList.toggle("collapse")):t.target==document.querySelector("form textarea")&&(e=document.querySelector("form textarea"),"Enter"!==t.code||t.shiftKey?38!=t.keyCode||""!==e.value&&"true"!==e.getAttribute("inStorage")?40!=t.keyCode||""!==e.value&&"true"!==e.getAttribute("inStorage")||o("forward",e):o("back",e):(addInputMaxLength(),removeAllQuickPrompts(),"true"===e.getAttribute("inStorage")&&(n=0,e.setAttribute("inStorage","false")),waitForElement(".dark\\:bg-gray-800 > .text-base",()=>{let t=!1;for(var e=Date.now(),o=document.querySelectorAll(".dark\\:bg-gray-800 > .text-base"),i=o[o.length-1];!t&&Date.now()-e<3e3;)""!==i.innerText&&(t=!0,function(e){handleStorage("get","promptHistory","",t=>{(t="object"!=typeof t?[]:t).push({prompt:e,time:Date.now()}),handleStorage("set","promptHistory",t,()=>{},"local")},"local")}(i.innerText))})))});var n=0,r=0;function o(o,i){handleStorage("get","promptHistory","",t=>{if(t){if(t.reverse(),r=t.length,"back"===o&&n<r)n++,i.value=t[n-1].prompt;else if("forward"===o){if(!(1<n))return i.value="",n=0,void i.setAttribute("inStorage","false");n--,i.value=t[n-1].prompt}i.setAttribute("inStorage","true");const e=()=>{""===i.value&&(i.setAttribute("inStorage","false"),n=0,i.removeEventListener("input",e))};i.addEventListener("input",e)}else toast("Your History Is Empty")},"local")}document.addEventListener("keyup",t=>{(t.ctrlKey&&"Escape"===t.key||t.ctrlKey&&"Backspace"===t.key)&&(t=document.querySelector("main form > div > div > button.btn-neutral"),"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName||document.activeElement==document.querySelector("form textarea"))&&t&&"stop generating"===t.innerText.toLowerCase()&&t.click()}),chrome.runtime.onMessage.addListener((t,e,o)=>{"openChat"==t.text?(console.debug("check for not send prompts"),lookAndInputPrompt()):(console.log("got query"),3e3<query.length&&(query=query.substring(0,3e3),chrome.runtime.sendMessage({text:"cut text to 3000 characters"})),sendPrompt(query))})}),lookAndInputPrompt();const copyRichText=async t=>{t=t.innerHTML,t=new Blob([t],{type:"text/html"}),t=new ClipboardItem({"text/html":t});await navigator.clipboard.write([t])};function whereIsEl(t){var e;if(t)return t=t.getBoundingClientRect(),e=window.innerHeight,t.bottom<=0?"above":t.top>=e?"below":"view"}function toast(t,e={callback:()=>{},time:2e3}){document.getElementById("toast")?.remove(),(e=e||{}).callback=e.callback||function(){},e.time=e.time||2e3;var o=Object.assign(document.createElement("div"),{id:"toast",innerText:t,className:"gpt-optimizer gpto-toast",style:"transition: .8s  cubic-bezier(0.25, 0.46, 0.45, 0.94);",onclick:t=>{e.callback(t),t.remove()}});document.body.appendChild(o),setTimeout(()=>{o.style.bottom="20px",setTimeout(()=>{o.style.bottom="-315px",setTimeout(()=>{o.remove()},800)},e.time)},1)}function setTheme(t,e="dark"){handleStorage("set","theme",t),removeTheme(),("dark"==t||"light"!==t&&"dark"==e)&&(document.documentElement.theme="dark",document.documentElement.classList.add("dark"),document.documentElement.style="color-scheme: dark;"),("light"==t||"dark"!==t&&"light"==e)&&(document.documentElement.theme="light",document.documentElement.classList.add("light"),document.documentElement.style="color-scheme: light;");e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href=t+"?load="+Date.now(),e.id="gpt-optimizer-theme",document.head.appendChild(e)}function removeTheme(){document.documentElement.classList.remove("light","dark");var t=document.querySelector("#gpt-optimizer-theme");t&&t.remove()}function removeAllEventListeners(t){var e=t.cloneNode(!0);return t.parentNode.replaceChild(e,t),e}function log(t,e="l"){"l"===e?console.log("%cchat gpt opzimizer: %clog "+t,"color: white;"):"w"===e?console.log("%cchat gpt opzimizer: %clog "+t,"font-weight: bold","color: yellow;"):"e"===e&&console.log("%cchat gpt opzimizer: %clog "+t,"font-weight: bold","color: red;")}async function sendPrompt(e){!1===sendingQuery?(sendingQuery=!0,waitForElement("form textarea",t=>{t.value=e,document.evaluate('//*[@id="__next"]/div/div[1]/main/div[2]/form/div/div[2]/button',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue.click(),document.evaluate(xpathChatgptHomeMessage,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue||(sendingQuery=!1,chrome.storage.local.set({promptCurrentText:!1,query:!1}),console.log("inserted prompt from other page"))},3e4,250)):console.log("there is already a query in sending")}function screenshotChat(){waitForElement("main > div > div > div > div",t=>{toast("Generating..."),html2canvas(t,{ignoreElements:t=>t.classList.contains("gpto-actions")||t.classList.contains("flex-shrink-0")||t.classList.contains("gpto-deleteMessage")||t.classList.contains("gpto-thumbsToRate")}).then(t=>{var e=document.createElement("a");e.href=t.toDataURL(),e.download=`ChatGPT Screenshot [${getDate("YYYY-MM-DD")}].png`,e.click()})})}function fetchURL(t,e){t=convertToHttps(t);fetch("https://productivity.rocks/tool/ai-optimizer/api/corsAnywhere/?url="+t).then(t=>{if(t.ok)return t.text();throw new Error("Network response was not ok")}).then(t=>{e(t)}).catch(t=>{e("Fetch error:"+t)})}function convertToHttps(t){return t.startsWith("https://")?t:t.startsWith("http://")?t.replace("http://","https://"):(t.startsWith("www."),"https://"+t)}function isValidDomain(t){return/^(https?:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}(\.[a-z]{2,})?(\/.*)?$/i.test(t)}