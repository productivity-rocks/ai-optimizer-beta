var sendingQuery=!1,promptCurrentText=!1,promptTime=0,xpathFirstChatMessage="/html/body/div/div/div[1]/main/div[1]/div/div/div/div[1]/div/div[2]/div[1]/div",xpathChatgptHomeMessage="/html/body/div/div[1]/div[1]/main/div[1]/div/div/div/div[1]/h1";const allAnswers=()=>[...document.querySelectorAll(".markdown.prose")];var getPreLastMessage=()=>(messages=document.querySelectorAll(".text-base .markdown"))[messages.length-2];waitForElement("body > div:nth-child(4) > span > div > div > div",e=>{e.style.display="none",toast(e.textContent,{time:4e3})},5e3,5),setInterval(()=>{var e=document.querySelector("body > div > div > div > div > h2");e&&e.textContent.includes("a client-side exception has occurred")&&(e.innerHTML="Hey, an unknown error has occurred. Drop a mail to ai@productivity.rocks to let the developers know!\nIf you know how to attach the console log, that would be helpful.")},500),window.addEventListener("load",()=>{handleStorage("get","updateNotify","",e=>{e&&"1.9.2"===e||waitForElement("nav a, form textarea",()=>{const e=Object.assign(document.createElement("div"),{id:"featureNotifier",style:`
                        position: fixed;
                        bottom: 50%;
                        right: 50%;
                        width: 100vw;
                        max-width: 400px;
                        height: 100vh;
                        max-height: 300px;
                        background: #202022;
                        border-radius: 1rem;
                        color: #fefefe;
                        overflow-x: hidden;
                        overflow-y: scroll;
                        padding: .4rem;
                        transform: translate(50%, 50%);
                        box-shadow: -1px 7px 100000px 200000px rgba(10,10,10,0.2);
                    `}),t=((featuresContent=Object.assign(document.createElement("div"),{style:`
                    margin-top: 3rem;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: .8rem;
                    `})).innerHTML=`
                <h4>Release Note</h4>
                <a href="https://productivity.rocks/tool/ai-optimizer/#upcoming" target="_blank" style="background: #ddd;padding: 0.4rem 1rem;color: rgb(32, 32, 34);font-weight: 600;border-radius: 0.6rem;cursor: pointer;font-size: .7rem;">Submit An Idea ðŸ“«</a>
                <ol style='list-style: circle; font-size: .8rem; padding-left: 1rem;'>
                    <li style="list-style:'ðŸ’¨'; color: #d2d2d2">&nbsp; Quick Prompts On Input</li>
                    <li style="list-style:'ðŸ“ˆ'; color: #d2d2d2">&nbsp; Pass "On Low Capacity" Page</li>
                    <li style="list-style:'âš¡ï¸'; color: #d2d2d2">&nbsp; Jailbreak ChatGPT with DAN Model</li>
                    <li style="list-style:'ðŸ‘€'; color: #d2d2d2">&nbsp; New Theme: "Matrix"</li>
                    <li style="list-style:'ðŸ«³'; color: #d2d2d2">&nbsp; Add Chat Download Buttons</li>
                    <li style="list-style:'ðŸ“–'; color: #d2d2d2">&nbsp; Horizontal word break for too long messages in width</li>
                    <li style="list-style:'ðŸ—‘ï¸'; color: #d2d2d2">&nbsp; Delete Message Button</li>
                    <li style="list-style:'ðŸ’«'; color: #d2d2d2">&nbsp; Compatible with ChatGPT Plus</li>
                    <li style="list-style:'ðŸ—’ï¸'; color: #d2d2d2; margin-top: .8rem;">&nbsp; <b>Note:</b><br>In the last update, users were asked to give this plugin new permissions, which caused some users to uninstall the plugin. In this message we just want to clarify that we are not focused on storing any data, we run as much as possible on the user's device, more complicated stuff will be run on a server in the future for security and performance reasons. Within the last permission we added that users can request full pages via the context menu. <br> Sorry for any disappointment, if we had known this would be so prominent for so little change we would have found another way. But rest assured, we're learning and improving!</li>
                </ol>
                `,e.appendChild(featuresContent),e.appendChild(Object.assign(document.createElement("h2"),{textContent:"ChatGPT Optimizer",style:`
                        top: .8rem;
                        left: 50%;
                        transform: translate(-50%);
                        position: absolute;
                        font-size: 14px;
                        line-height: 24px;
                        color: #a4a4a4;
                    `})),Object.assign(document.createElement("div"),{style:`
                        min-height: .4rem;
                        width: 100%;
                        border-radius: 10rem;
                        background: #d2d2d2;
                        bottom: 0px;
                        transition: all 6s linear 0s;
                        position: sticky;
                        align-self: flex-start;
                        opacity: .4;
                        margin-top: .6rem;
                    `}));e.appendChild(Object.assign(document.createElement("span"),{style:`
                        position: absolute;
                        top: .8rem;
                        left: .8rem;
                        font-size: 14px;
                        color: #a4a4a4;
                    `,innerText:"v 1.9.2"})),e.appendChild(t);var o=document.createElement("div"),n=(Object.assign(o.style,{position:"absolute",top:".75rem",right:".8rem",display:"inline-block",width:"24px",height:"24px",cursor:"pointer"}),o.onclick=()=>{e.close()},document.createElement("div")),i=(Object.assign(n.style,{position:"absolute",content:"",height:"14px",width:"2px",top:"5px",left:"11px",backgroundColor:"#a4a4a4",borderRadius:"2px",transform:"rotate(-45deg)"}),document.createElement("div"));Object.assign(i.style,{position:"absolute",content:"",height:"14px",width:"2px",top:"5px",left:"11px",backgroundColor:"#a4a4a4",borderRadius:"2px",transform:"rotate(45deg)"}),o.appendChild(n),o.appendChild(i),e.appendChild(o);let a,r;e.startCountdown=()=>{a=setTimeout(()=>{t.style.transition="6s linear",t.style.width="0%",r=setTimeout(()=>{e.close()},6e3)},100)},e.close=()=>{e.remove(),handleStorage("set","updateNotify","1.9.2")},e.startCountdown(),e.addEventListener("mouseenter",()=>{a&&clearTimeout(a),r&&clearTimeout(r);var e=t.style.transition;setTimeout(()=>{t.style.transition=".15s ease-in-out",t.style.width="100%",setTimeout(()=>{t.style.transition=e},100)},1)}),e.addEventListener("mouseleave",()=>{e.startCountdown()}),document.body.appendChild(e)})}),waitForElement("nav a, form textarea",()=>{},5e3,100,()=>{toast("chat not loading, try reloading the page")}),waitForElement("main > :nth-child(2) form > :nth-child(1) > :nth-child(2)",e=>{e.click()}),"https://chat.openai.com/auth/login"==window.location.href&&waitForElement(".text-3xl.font-medium",e=>{e.innerText.contains("capacity right now")&&(window.location.href="https://chat.openai.com")}),waitForElement("main > div.overflow-hidden",e=>{e=e.firstChild;e.scrollTop=e.scrollHeight}),handleStorage("get","theme","",e=>{setTheme(e)}),document.addEventListener("keydown",e=>{var t;e.ctrlKey&&"c"===e.key||e.metaKey&&"c"===e.key?""===window.getSelection().toString().trim()?(isFinite(e.clientX)&&isFinite(e.clientY)&&(t=document.elementFromPoint(e.clientX,e.clientY)).matches("button.gpt-optimizer")?t:getLastMessage().parentNode.querySelector("button.gpt-optimizer")).click():(navigator.clipboard.writeText(window.getSelection().toString()),toast("Copied Selection")):"Space"===e.code||" "===e.key?"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&(e.preventDefault(),document.body.classList.toggle("collapse")):e.target==document.querySelector("form textarea")&&(t=document.querySelector("form textarea"),"Enter"!==e.code||e.shiftKey?38!=e.keyCode||""!==t.value&&"true"!==t.getAttribute("inStorage")?40!=e.keyCode||""!==t.value&&"true"!==t.getAttribute("inStorage")||o("forward",t):o("back",t):(console.log("prompt send"),addInputMaxLength(),removeAllQuickPrompts(),"true"===t.getAttribute("inStorage")&&(i=0,t.setAttribute("inStorage","false")),waitForElement(".dark\\:bg-gray-800 > .text-base",()=>{let e=!1;for(var t=Date.now(),o=document.querySelectorAll(".dark\\:bg-gray-800 > .text-base"),n=o[o.length-1];!e&&Date.now()-t<3e3;)""!==n.innerText&&(e=!0,function(t){handleStorage("get","promptHistory","",e=>{(e="object"!=typeof e?[]:e).push({prompt:t,time:Date.now()}),a=e.length,handleStorage("set","promptHistory",e,()=>{handleStorage("get","promptHistory","",e=>{console.log(e)})})})}(n.innerText))})))});var i=0,a=0;function o(o,n){handleStorage("get","promptHistory","",e=>{if(e.reverse(),a=e.length,"back"===o&&i<a)i++,n.value=e[i-1].prompt;else if("forward"===o){if(!(1<i))return n.value="",i=0,void n.setAttribute("inStorage","false");i--,n.value=e[i-1].prompt}n.setAttribute("inStorage","true");const t=()=>{""===n.value&&(n.setAttribute("inStorage","false"),i=0,n.removeEventListener("input",t))};n.addEventListener("input",t)})}document.addEventListener("keyup",e=>{(e.ctrlKey&&"Escape"===e.key||e.ctrlKey&&"Backspace"===e.key)&&(e=document.querySelector("main form > div > div > button.btn-neutral"),"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName||document.activeElement==document.querySelector("form textarea"))&&e&&"stop generating"===e.innerText.toLowerCase()&&e.click()}),chrome.runtime.onMessage.addListener((e,t,o)=>{if("openChat"==e.text){console.debug("check for not send prompts");try{chrome.storage.local.get(["promptCurrentText"],e=>{e.promptCurrentText&&chrome.storage.local.get(["promptTime"],e=>{e.promptTime+6e5>Date.now()&&chrome.storage.local.get(["promptLastText"],e=>{sendPrompt(e.promptLastText),chrome.storage.local.set({promptCurrentText:!1})})})})}catch(e){console.log("no active query found")}setTimeout(1e3)}else console.log("got query"),3e3<query.length&&(query=query.substring(0,3e3),chrome.runtime.sendMessage({text:"cut text to 3000 characters"})),sendPrompt(query)})});const copyRichText=async e=>{e=e.innerHTML,e=new Blob([e],{type:"text/html"}),e=new ClipboardItem({"text/html":e});await navigator.clipboard.write([e])};function whereIsEl(e){var t;if(e)return e=e.getBoundingClientRect(),t=window.innerHeight,e.bottom<=0?"above":e.top>=t?"below":"view"}function toast(e,t={callback:()=>{},time:2e3}){document.getElementById("toast")?.remove(),(t=t||{}).callback=t.callback||function(){},t.time=t.time||2e3;var o=Object.assign(document.createElement("div"),{id:"toast",innerText:e,className:"gpt-optimizer gpto-toast",style:"transition: .8s  cubic-bezier(0.25, 0.46, 0.45, 0.94);",onclick:e=>{t.callback(e),e.remove()}});document.body.appendChild(o),setTimeout(()=>{o.style.bottom="20px",setTimeout(()=>{o.style.bottom="-315px",setTimeout(()=>{o.remove()},800)},t.time)},1)}function setTheme(e,t="dark"){handleStorage("set","theme",e),removeTheme(),("dark"==e||"light"!==e&&"dark"==t)&&(document.documentElement.theme="dark",document.documentElement.classList.add("dark"),document.documentElement.style="color-scheme: dark;"),("light"==e||"dark"!==e&&"light"==t)&&(document.documentElement.theme="light",document.documentElement.classList.add("light"),document.documentElement.style="color-scheme: light;");t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e+"?load="+Date.now(),t.id="gpt-optimizer-theme",document.head.appendChild(t)}function removeTheme(){document.documentElement.classList.remove("light","dark");var e=document.querySelector("#gpt-optimizer-theme");e&&e.remove()}function removeAllEventListeners(e){var t=e.cloneNode(!0);return e.parentNode.replaceChild(t,e),t}function log(e,t="l"){"l"===t?console.log("%cchat gpt opzimizer: %clog "+e,"color: white;"):"w"===t?console.log("%cchat gpt opzimizer: %clog "+e,"font-weight: bold","color: yellow;"):"e"===t&&console.log("%cchat gpt opzimizer: %clog "+e,"font-weight: bold","color: red;")}async function sendPrompt(e){if(0==sendingQuery&&document.evaluate(xpathChatgptHomeMessage,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue){sendingQuery=!0;for(var t=Date.now()+15e3,o=!1;!o&&Date.now()<t;)if(console.debug("searching for textarea to send prompt"),await new Promise(e=>setTimeout(e,250)),document.querySelector("textarea"))for(var n=document.querySelector("textarea"),o=!0,t=Date.now()+1e4,i=!1;!i&&Date.now()<t;)await new Promise(e=>setTimeout(e,300)),n.value=e,await new Promise(e=>setTimeout(e,20)),document.evaluate('//*[@id="__next"]/div/div[1]/main/div[2]/form/div/div[2]/button',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue.click(),document.evaluate(xpathChatgptHomeMessage,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue||(document.querySelector("textarea").value="",sendingQuery=!(i=!0),chrome.storage.local.set({query:!1}),console.log("conversation started and function done"));console.log("prompt couldn't be send after ... seconds of trying")}else console.log("prompt was already send")}function say(e){console.log("say",e);var t=window.speechSynthesis,e=new SpeechSynthesisUtterance(e),o=(e.lang="en-US",e.pitch=1,e.rate=1,e.volume=1,t.getVoices());e.voice=o[1],t.speak(e)}function screenshotChat(){waitForElement("main > div > div > div > div",t=>{toast("Generating..."),html2canvas(t,{ignoreElements:e=>e.classList.contains("gpto-actions")||e===t.classList.contains("flex-shrink-0")}).then(e=>{var t=document.createElement("a");t.href=e.toDataURL(),t.download=`ChatGPT Screenshot [${getDate("YYYY-MM-DD")}].png`,t.click()})})}